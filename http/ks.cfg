# Kickstart file for CentOS Stream 9 minimal installation
# Automatically generated by Packer
# Root password for root and 'vagrant' user
rootpw --plaintext YOURPASSWORD
user --name=vagrant --password=YOURPASSWORD --plaintext

# Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl'

# System language
lang en_US.UTF-8

# Firewall configuration
firewall --disabled

# Network configuration
network --bootproto=dhcp --activate --hostname=centos9-stream

# System timezone
timezone Europe/Warsaw --isUtc

# System services
services --enabled="sshd" --disabled="cloud-init,cloud-init-local,cloud-config,cloud-final"

# Disk partitioning
clearpart --all --initlabel
autopart --type=plain --nohome
bootloader --location=mbr --boot-drive=sda

# Repositories (użyj ścieżek z Twojego ISO lub z mirrora)
# Upewnij się, że te URL są dostępne podczas instalacji
repo --name="BaseOS" --baseurl="http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/"
repo --name="AppStream" --baseurl="http://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/"

# Installation media (ważne dla Anacondy, aby wiedziała, skąd pobierać pakiety)


# Packages to install (minimalny zestaw dla maszyny bazowej + narzędzia)
%packages --ignoremissing
@^minimal-environment
@core
chrony
cloud-init
openssh-server
openssh-clients
sudo
wget
curl
net-tools
rsync
kernel-headers
kernel-devel
gcc
make
perl
dmidecode
-iwl*firmware # Wyklucza pakiety firmware dla kart WiFi, często niepotrzebne w VM
%end

%pre
# Sekcja %pre jest wykonywana przed rozpoczęciem instalacji
# Możesz tu umieścić skrypty sprawdzające środowisko itp.
%end

%post --log=/var/log/anaconda/post-install.log
# Sekcja %post jest wykonywana po zainstalowaniu pakietów, ale przed pierwszym uruchomieniem systemu
# Configure sudo for vagrant user
echo "vagrant ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/vagrant
chmod 0440 /etc/sudoers.d/vagrant

# Install Vagrant public key (for SSH access during provisioning)
mkdir -pm 700 /home/vagrant/.ssh
wget --no-check-certificate \
    https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub \
    -O /home/vagrant/.ssh/authorized_keys
chmod 0600 /home/vagrant/.ssh/authorized_keys
chown -R vagrant: /home/vagrant/.ssh

# Remove unused services for a cleaner box
systemctl disable firewalld
systemctl stop firewalld

# Clean up dnf cache
dnf clean all

# Zero out the free space to reduce the size of the output VM
# This helps make the .box file smaller and more efficient
dd if=/dev/zero of=/EMPTY bs=1M || true
rm -f /EMPTY

# Remove cloud-init files if not using cloud-init (or reconfigure if needed)
# This prevents issues with subsequent VM clones
rm -rf /var/lib/cloud/instances/*
rm -rf /var/lib/cloud/data/*
rm -rf /var/lib/cloud/sem/*

# Remove SSH host keys - they will be regenerated on first boot for new VMs
rm -f /etc/ssh/ssh_host_*

# Clear log files
for f in $(find /var/log -type f -name '*.log'); do cat /dev/null > "$f"; done
history -c

%end

# Reboot after installation
reboot